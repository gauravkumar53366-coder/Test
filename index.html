<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3D Plot Locator - Google Satellite</title>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <!-- Turf.js -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        :root {
            --primary: #1e40af; /* Dark blue */
            --primary-dark: #1e3a8a; /* Darker shade */
            --surface: #ffffff;
            --border: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --shadow: 0 6px 12px -2px rgba(0,0,0,0.15);
            --radius: 10px; /* Larger radius for modern look */
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother easing */
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #f9fafb; color: var(--text-primary); font-size: 14px; }
        #map { position: fixed; inset: 0; z-index: 1; background: #e6eefc; }

        /* Header */
        .app-header { 
            position: absolute; top: 16px; left: 16px; z-index: 1100; 
            display: flex; flex-direction: column; align-items: flex-start; gap: 10px; 
        }
        .app-title { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            padding: 12px 18px; border-radius: var(--radius); color: white; 
            font-weight: 600; display: flex; gap: 8px; align-items: center; 
            box-shadow: 0 8px 16px rgba(30, 64, 175, 0.4); 
            transform: translateY(0); transition: var(--transition); 
        }
        .app-title:hover { transform: translateY(-3px); box-shadow: 0 12px 20px rgba(30, 64, 175, 0.5); }
        .control-buttons { display: flex; gap: 10px; }

        .btn-3d {
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            background: var(--surface); color: var(--text-primary); border: none;
            padding: 10px 14px; border-radius: var(--radius); cursor: pointer;
            font-weight: 500; font-size: 13px; box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            transform: translateY(0); transition: var(--transition);
        }
        .btn-3d:hover { 
            transform: translateY(-4px) scale(1.05); 
            box-shadow: 0 12px 20px rgba(0,0,0,0.2); 
            background: #f8fafc; 
        }
        .btn-3d:active { 
            transform: translateY(0) scale(0.98); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        .btn-3d-primary { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; 
            box-shadow: 0 6px 12px rgba(30, 64, 175, 0.4); 
        }
        .btn-3d-primary:hover { 
            box-shadow: 0 12px 20px rgba(30, 64, 175, 0.5); 
            transform: translateY(-4px) scale(1.05); 
        }
        .btn-icon { width: 40px; height: 40px; padding: 6px; }

        .btn-3d.loading { position: relative; }
        .btn-3d.loading::after {
            content: ''; position: absolute; width: 16px; height: 16px; 
            border: 2px solid #fff; border-top-color: transparent;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.6; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pulse-marker { animation: pulse 1.5s infinite; }

        /* Sidebar */
        .sidebar { 
            position: absolute; left: 16px; top: 80px; z-index: 1050; 
            width: 240px; max-width: 75vw; background: var(--surface); 
            border-radius: var(--radius); transform: translateX(-110%); 
            transition: var(--transition); overflow: hidden; 
            max-height: calc(100% - 100px); display: flex; flex-direction: column; 
            box-shadow: 0 12px 24px rgba(0,0,0,0.2); border: 1px solid var(--border); 
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { 
            padding: 12px 16px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: #fff; display: flex; align-items: center; justify-content: space-between; 
            font-weight: 600; font-size: 13px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        .sidebar-content { padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }

        .section { 
            background: #f8fafc; padding: 10px 12px; border-radius: var(--radius); 
            border-left: 4px solid var(--primary); box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        .section-title { 
            font-weight: 600; font-size: 13px; display: flex; gap: 8px; 
            align-items: center; color: var(--text-primary); margin-bottom: 6px; 
        }

        .form-group { margin-bottom: 6px; }
        .form-label { font-size: 11px; color:var(--text-secondary); margin-bottom: 4px; display:block; font-weight:500; }
        .input { 
            width: 100%; padding: 8px 12px; border-radius: var(--radius); 
            border: 1px solid var(--border); background: var(--surface); 
            color: var(--text-primary); font-size: 13px; transition: var(--transition); 
        }
        .input:focus { 
            border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15); outline: none; 
        }

        .input-group { display: flex; gap: 6px; align-items: center; }
        .input-group .input { flex: 1; }
        .input-group .btn-3d { flex-shrink: 0; }

        .sidebar .btn-3d { width: 40px; height: 40px; padding: 0; border-radius: var(--radius); justify-content: center; font-size: 15px; }
        .sidebar .btn-3d span { display: none; }
        .sidebar .btn-3d i { font-size: 15px; }

        .toggle-group { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
        .toggle-label { display: flex; gap: 8px; align-items: center; font-weight: 500; color: var(--text-primary); font-size: 13px; }

        .leaflet-control-zoom { 
            border: none !important; border-radius: var(--radius) !important; 
            overflow: hidden; box-shadow: 0 6px 12px rgba(0,0,0,0.1) !important; 
        }
        .leaflet-control-zoom a { 
            background: var(--surface) !important; color: var(--text-primary) !important; 
            width: 36px; height: 36px; line-height: 36px; font-size: 16px; 
        }
        .leaflet-popup-content-wrapper { 
            background: var(--surface); border-radius: var(--radius); 
            border: 1px solid var(--border); padding: 10px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); 
        }
        .leaflet-popup-close-button { 
            background: var(--primary); color: #fff; border-radius: 50%; 
            width: 24px; height: 24px; line-height: 24px; top: 8px; right: 8px; 
        }

        .toast { 
            position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 2000; 
            padding: 10px 16px; background: var(--surface); border-radius: var(--radius); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: flex; gap: 8px; 
            align-items: center; opacity: 0; transition: var(--transition); pointer-events: none; 
            border: 1px solid var(--border); 
        }
        .toast.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }

        .map-legend, .leaflet-control-attribution { display: none !important; }

        @media (max-width: 780px) {
            .sidebar { width: 220px; left: 8px; top: 70px; }
            .app-header { left: 12px; top: 12px; gap: 8px; }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="app-header">
        <div class="app-title">
            <i class="fas fa-map-marker-alt"></i>
            <span>Plot Locator</span>
        </div>
        <div class="control-buttons">
            <button id="menuBtn" class="btn-3d" title="‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç"><i class="fas fa-bars"></i><span>‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç</span></button>
            <button id="homeBtn" class="btn-3d" title="‡§π‡•ã‡§Æ"><i class="fas fa-home"></i><span>‡§π‡•ã‡§Æ</span></button>
        </div>
    </div>

    <div id="sidebar" class="sidebar" aria-hidden="true">
        <div class="sidebar-header">
            <span>Plot Locator ‡§ü‡•Ç‡§≤‡•ç‡§∏</span>
            <button id="closeSidebarBtn" class="btn-3d btn-icon" title="‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç"><i class="fas fa-times"></i></button>
        </div>
        <div class="sidebar-content">
            <div class="section">
                <div class="section-title"><i class="fas fa-search"></i><span>‡§™‡•ç‡§≤‡•â‡§ü ‡§ñ‡•ã‡§ú‡•á‡§Ç</span></div>
                <div class="form-group">
                    <label class="form-label">‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</label>
                    <div class="input-group">
                        <input id="multiPlotInput" class="input" placeholder="‡§â‡§¶‡§æ: 2576 ‡§Ø‡§æ 2576,2577" />
                        <button id="multiSearchBtn" class="btn-3d btn-3d-primary" title="‡§™‡•ç‡§≤‡•â‡§ü ‡§ñ‡•ã‡§ú‡•á‡§Ç"><i class="fas fa-search"></i><span>‡§ñ‡•ã‡§ú</span></button>
                    </div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-top:6px;">‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 5 ‡§™‡•ç‡§≤‡•â‡§ü ‡§è‡§ï ‡§∏‡§æ‡§• ‡§ñ‡•ã‡§ú‡•á‡§Ç</div>
                </div>
                <div style="display:flex; gap:8px; margin-top:6px;">
                    <button id="resetSearchBtn" class="btn-3d" title="‡§∞‡•Ä‡§∏‡•á‡§ü"><i class="fas fa-refresh"></i><span>‡§∞‡•Ä‡§∏‡•á‡§ü</span></button>
                    <button id="voiceBtn" class="btn-3d" title="‡§µ‡•â‡§Ø‡§∏ ‡§∏‡§∞‡•ç‡§ö"><i class="fas fa-microphone"></i><span>‡§Ü‡§µ‡§æ‡§ú</span></button>
                </div>
            </div>
            <div class="section">
                <div class="section-title"><i class="fas fa-layer-group"></i><span>‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó</span></div>
                <div class="toggle-group">
                    <div class="toggle-label"><i class="fas fa-vector-square"></i><span>‡§™‡•ç‡§≤‡•â‡§ü‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç</span></div>
                    <label class="toggle-switch" title="‡§™‡•ç‡§≤‡•â‡§ü‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç/‡§õ‡•Å‡§™‡§æ‡§è‡§Å">
                        <input type="checkbox" id="togglePlots" checked />
                        <span class="toggle-slider" style="display:none;"></span>
                    </label>
                </div>
                <div class="toggle-group">
                    <div class="toggle-label"><i class="fas fa-tag"></i><span>‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç</span></div>
                    <label class="toggle-switch" title="‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å/‡§õ‡•Å‡§™‡§æ‡§è‡§Å">
                        <input type="checkbox" id="toggleLabels" />
                        <span class="toggle-slider" style="display:none;"></span>
                    </label>
                </div>
            </div>
            <div class="section">
                <div class="section-title"><i class="fas fa-location-arrow"></i><span>‡§≤‡•ã‡§ï‡•á‡§∂‡§®</span></div>
                <div style="display:flex; gap:8px;">
                    <button id="locateBtn" class="btn-3d" title="‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®"><i class="fas fa-location-crosshairs"></i><span>‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®</span></button>
                    <button id="fitBtn" class="btn-3d" title="‡§∏‡§≠‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç"><i class="fas fa-expand"></i><span>‡§∏‡§≠‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç</span></button>
                </div>
            </div>
            <div class="section">
                <div class="section-title"><i class="fas fa-ruler-combined"></i><span>‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Æ‡§æ‡§™ ‡§ü‡•Ç‡§≤</span></div>
                <button id="measureToggleBtn" class="btn-3d" title="‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Æ‡§æ‡§™"><i class="fas fa-ruler"></i><span>‡§Æ‡§æ‡§™</span></button>
                <div id="measurePanel" class="measure-panel" style="display:none; margin-top:8px;">
                    <div style="display:flex; flex-direction:column; gap:6px;">
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <button id="startMeasureBtn" class="btn-3d" title="‡§∂‡•Å‡§∞‡•Ç"><i class="fas fa-play"></i><span>‡§∂‡•Å‡§∞‡•Ç</span></button>
                            <button id="undoMeasureBtn" class="btn-3d" disabled title="‡§™‡•Ç‡§∞‡•ç‡§µ‡§µ‡§§"><i class="fas fa-undo"></i><span>‡§™‡•Ç‡§∞‡•ç‡§µ‡§µ‡§§</span></button>
                            <button id="finishMeasureBtn" class="btn-3d" disabled title="‡§∏‡§Æ‡§æ‡§™‡•ç‡§§"><i class="fas fa-check"></i><span>‡§∏‡§Æ‡§æ‡§™‡•ç‡§§</span></button>
                            <button id="clearMeasureBtn" class="btn-3d" title="‡§∏‡§æ‡§´‡§º"><i class="fas fa-trash"></i><span>‡§∏‡§æ‡§´‡§º</span></button>
                        </div>
                        <div id="measureInfo" class="measure-info" style="background:var(--surface); padding:8px; border-radius:var(--radius); border:1px solid var(--border); color:var(--text-secondary);">‡§¨‡§ø‡§Ç‡§¶‡•Å: 0</div>
                        <div class="form-group">
                            <label class="form-label">‡§Æ‡§æ‡§™ ‡§á‡§ï‡§æ‡§à</label>
                            <select id="unitSelect" class="input">
                                <option value="sqft">‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (sq ft)</option>
                                <option value="sqm" selected>‡§µ‡§∞‡•ç‡§ó ‡§Æ‡•Ä‡§ü‡§∞ (sq m)</option>
                                <option value="acre">‡§è‡§ï‡§°‡§º (acre)</option>
                                <option value="dismil">‡§°‡§ø‡§∏‡§Æ‡§ø‡§≤ (dismil)</option>
                                <option value="bigha">‡§¨‡•Ä‡§ò‡§æ (bigha)</option>
                                <option value="kattha">‡§ï‡§ü‡•ç‡§†‡§æ (kattha)</option>
                                <option value="dhur">‡§ß‡•Å‡§∞ (dhur)</option>
                                <option value="dhurki">‡§ß‡•Å‡§∞‡§ï‡•Ä (dhurki)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="section-title"><i class="fas fa-route"></i><span>‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Æ‡§æ‡§™ ‡§ü‡•Ç‡§≤ (‡§ò‡•Ç‡§Æ‡§ï‡§∞ ‡§Æ‡§æ‡§™‡•á‡§Ç)</span></div>
                <button id="gpsMeasureToggleBtn" class="btn-3d" title="‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Æ‡§æ‡§™"><i class="fas fa-walking"></i><span>‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏</span></button>
                <div id="gpsMeasurePanel" class="gps-measure-panel" style="display:none; margin-top:8px;">
                    <div style="display:flex; gap:6px; flex-wrap:wrap;">
                        <button id="startGpsMeasureBtn" class="btn-3d" title="‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç"><i class="fas fa-play"></i><span>‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó</span></button>
                        <button id="stopGpsMeasureBtn" class="btn-3d btn-3d-error" disabled title="‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•á‡§Ç"><i class="fas fa-stop"></i><span>‡§∞‡•ã‡§ï‡•á‡§Ç</span></button>
                        <button id="finishGpsMeasureBtn" class="btn-3d" disabled title="‡§Æ‡§æ‡§™ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§"><i class="fas fa-check"></i><span>‡§∏‡§Æ‡§æ‡§™‡•ç‡§§</span></button>
                        <button id="clearGpsMeasureBtn" class="btn-3d" title="‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç"><i class="fas fa-trash"></i><span>‡§∏‡§æ‡§´‡§º</span></button>
                    </div>
                    <div id="gpsMeasureInfo" style="background:var(--surface); padding:8px; border-radius:var(--radius); border:1px solid var(--border); color:var(--text-secondary); margin-top:8px;">‡§¨‡§ø‡§Ç‡§¶‡•Å: 0 | ‡§¶‡•Ç‡§∞‡•Ä: 0 m</div>
                    <div style="margin-top:8px;">
                        <label class="form-label">‡§Æ‡§æ‡§™ ‡§á‡§ï‡§æ‡§à (‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è)</label>
                        <select id="gpsUnitSelect" class="input">
                            <option value="sqft">‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (sq ft)</option>
                            <option value="sqm" selected>‡§µ‡§∞‡•ç‡§ó ‡§Æ‡•Ä‡§ü‡§∞ (sq m)</option>
                            <option value="acre">‡§è‡§ï‡§°‡§º (acre)</option>
                            <option value="dismil">‡§°‡§ø‡§∏‡§Æ‡§ø‡§≤ (dismil)</option>
                            <option value="bigha">‡§¨‡•Ä‡§ò‡§æ (bigha)</option>
                            <option value="kattha">‡§ï‡§ü‡•ç‡§†‡§æ (kattha)</option>
                            <option value="dhur">‡§ß‡•Å‡§∞ (dhur)</option>
                            <option value="dhurki">‡§ß‡•Å‡§∞‡§ï‡•Ä (dhurki)</option>
                        </select>
                    </div>
                    <div style="font-size:11px;color:var(--text-secondary); margin-top:6px;">‡§®‡•ã‡§ü: ‡§™‡•ç‡§≤‡•â‡§ü ‡§ï‡•á ‡§ö‡§æ‡§∞‡•ã‡§Ç ‡§ì‡§∞ ‡§ß‡•Ä‡§∞‡•á-‡§ß‡•Ä‡§∞‡•á ‡§ò‡•Ç‡§Æ‡•á‡§Ç‡•§ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≤ ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ‡•§</div>
                </div>
            </div>
            <div class="section">
                <div class="section-title"><i class="fas fa-question-circle"></i><span>‡§∏‡§π‡§æ‡§Ø‡§§‡§æ</span></div>
                <button id="userGuideBtn" class="btn-3d" title="‡§â‡§™‡§Ø‡•ã‡§ó ‡§ó‡§æ‡§á‡§°"><i class="fas fa-book"></i><span>‡§ó‡§æ‡§á‡§°</span></button>
            </div>
        </div>
    </div>

    <div id="userGuidePanel" class="guide-panel" style="position:absolute; left:16px; top:80px; z-index:1050; width:280px; max-width:80vw; background:var(--surface); border-radius:var(--radius); padding:16px; transform:translateX(-120%); transition:all .3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 0 12px 24px rgba(0,0,0,0.2); border:1px solid var(--border);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <div style="font-weight:600; display:flex; gap:8px; align-items:center;"><i class="fas fa-book-open"></i> ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ó‡§æ‡§á‡§°</div>
            <button id="closeGuideBtn" class="btn-3d btn-icon" title="‡§¨‡§Ç‡§¶"><i class="fas fa-times"></i></button>
        </div>
        <div id="userGuideContent" style="font-size:13px; color:var(--text-secondary); line-height:1.5;">
            <h3 style="font-size:15px; color:var(--text-primary); margin-bottom:8px;">Plot Locator ‡§ó‡§æ‡§á‡§°</h3>
            <ul style="padding-left:20px; margin-top:8px;">
                <li><b>‡§™‡•ç‡§≤‡•â‡§ü‡•ç‡§∏ ‡§ñ‡•ã‡§ú:</b> ‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§ñ‡•ã‡§≤‡§ï‡§∞ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç (‡§â‡§¶‡§æ. 2576 ‡§Ø‡§æ 2576,2577) ‡§î‡§∞ ‡§ñ‡•ã‡§ú ‡§¶‡§¨‡§æ‡§è‡§Å‡•§</li>
                <li><b>‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞:</b> '‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç' ‡§ü‡•â‡§ó‡§≤ ‡§∏‡•á ‡§ú‡§º‡•Ç‡§Æ ‡§™‡§∞ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§ø‡§ñ‡•á‡§Ç‡§ó‡•á (‡§ú‡§º‡•Ç‡§Æ 16+)‡•§</li>
                <li><b>‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®:</b> ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§ï‡§∞ ‡§Ö‡§™‡§®‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§</li>
                <li><b>‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Æ‡§æ‡§™:</b> ‡§Æ‡§æ‡§™ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç ‚Üí ‡§®‡§ï‡•ç‡§∂‡•á ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§ï‡•á ‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§ú‡•ã‡§°‡§º‡•á‡§Ç ‚Üí ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</li>
                <li><b>‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Æ‡§æ‡§™:</b> ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§≤‡•â‡§ü ‡§ï‡•á ‡§ö‡§æ‡§∞‡•ã‡§Ç ‡§ì‡§∞ ‡§ò‡•Ç‡§Æ‡•á‡§Ç ‚Äî ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§™‡§∞ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≤ ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ‡•§</li>
            </ul>
            <p style="margin-top:10px; font-size:12px; color:var(--text-secondary);">‡§®‡•ã‡§ü: data.geojson ‡§´‡§æ‡§á‡§≤ ‡§ö‡§æ‡§π‡§ø‡§è‡•§</p>
        </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"><i class="fas fa-info-circle"></i><span id="toastMessage"></span></div>

    <div class="map-legend" aria-hidden="true" style="position:absolute; bottom:20px; right:10px; z-index:1000; background:var(--surface); padding:12px; border-radius:var(--radius); box-shadow:0 6px 12px rgba(0,0,0,0.12); border:1px solid var(--border);">
        <div style="display:flex; gap:8px; align-items:center;"><div style="width:20px;height:20px;background:#f59e0b;border-radius:3px;"></div><span>‡§™‡•ç‡§≤‡•â‡§ü ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞</span></div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;"><div style="width:20px;height:20px;background:#ef4444;border-radius:3px;"></div><span>‡§ö‡§Ø‡§®‡§ø‡§§ ‡§™‡•ç‡§≤‡•â‡§ü</span></div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;"><div style="width:20px;height:20px;border-radius:50%;background:transparent;border:3px solid white;"></div><span>‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Æ‡§æ‡§™ ‡§¨‡§ø‡§Ç‡§¶‡•Å</span></div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;"><div style="width:20px;height:20px;border-radius:50%;background:#059669;border:2px solid white;"></div><span>‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Æ‡§æ‡§™ ‡§¨‡§ø‡§Ç‡§¶‡•Å</span></div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;"><div style="width:20px;height:20px;border-radius:50%;background:#2563eb;border:2px solid white;"></div><span>‡§∞‡§ø‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ ‡§≤‡•ã‡§ï‡•á‡§∂‡§®</span></div>
    </div>

    <script>
        // Map initialization
        const map = L.map('map', { zoomControl: false }).setView([25.339365, 85.765942], 16);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0','mt1','mt2','mt3'],
            attribution: ''
        }).addTo(map);

        // Constants
        const PLOT_PROP = 'Name';
        const LABEL_BATCH_SIZE = 50;
        const MIN_ZOOM_FOR_LABELS = 16;
        const MAX_MULTI_SEARCH = 5;
        const GPS_MIN_DISTANCE = 3;
        const GPS_MIN_SPEED = 0.2;
        const GPS_MIN_TIME = 1500;
        const GPS_ACCURACY_THRESHOLD = 15;
        const GPS_INITIAL_ACCURACY = 30;

        // UI references
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menuBtn');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const homeBtn = document.getElementById('homeBtn');
        const multiSearchBtn = document.getElementById('multiSearchBtn');
        const resetSearchBtn = document.getElementById('resetSearchBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const multiPlotInput = document.getElementById('multiPlotInput');
        const togglePlotsBtn = document.getElementById('togglePlots');
        const toggleLabelsBtn = document.getElementById('toggleLabels');
        const locateBtn = document.getElementById('locateBtn');
        const fitBtn = document.getElementById('fitBtn');
        const measureToggleBtn = document.getElementById('measureToggleBtn');
        const measurePanel = document.getElementById('measurePanel');
        const startMeasureBtn = document.getElementById('startMeasureBtn');
        const undoMeasureBtn = document.getElementById('undoMeasureBtn');
        const finishMeasureBtn = document.getElementById('finishMeasureBtn');
        const clearMeasureBtn = document.getElementById('clearMeasureBtn');
        const measureInfo = document.getElementById('measureInfo');
        const unitSelect = document.getElementById('unitSelect');
        const gpsMeasureToggleBtn = document.getElementById('gpsMeasureToggleBtn');
        const gpsMeasurePanel = document.getElementById('gpsMeasurePanel');
        const startGpsMeasureBtn = document.getElementById('startGpsMeasureBtn');
        const stopGpsMeasureBtn = document.getElementById('stopGpsMeasureBtn');
        const finishGpsMeasureBtn = document.getElementById('finishGpsMeasureBtn');
        const clearGpsMeasureBtn = document.getElementById('clearGpsMeasureBtn');
        const gpsMeasureInfo = document.getElementById('gpsMeasureInfo');
        const gpsUnitSelect = document.getElementById('gpsUnitSelect');
        const userGuideBtn = document.getElementById('userGuideBtn');
        const userGuidePanel = document.getElementById('userGuidePanel');
        const closeGuideBtn = document.getElementById('closeGuideBtn');
        const toastEl = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        function toast(msg, ms = 2200) {
            toastMessage.textContent = msg;
            toastEl.classList.add('show');
            clearTimeout(window._t);
            window._t = setTimeout(() => toastEl.classList.remove('show'), ms);
        }

        // Layers and state
        let dataGeo = null;
        const plotLayer = L.geoJSON(null, {
            style: () => ({ color: '#f59e0b', weight: 2, fillOpacity: 0.15 }),
            onEachFeature: (feature, layer) => {
                layer.on('click', () => {
                    const pno = feature?.properties?.[PLOT_PROP] ?? 'Unknown';
                    const area_m2 = calculateArea(feature);
                    layer.bindPopup(`<b>‡§™‡•ç‡§≤‡•â‡§ü:</b> ${pno}<br>${formatAll(area_m2)}`).openPopup();
                    toast(`‡§™‡•ç‡§≤‡•â‡§ü ${pno} ‡§¶‡•á‡§ñ‡§æ ‡§ó‡§Ø‡§æ`);
                });
            }
        }).addTo(map);
        const labelLayer = L.layerGroup();
        let highlightLayer = null;
        let labelsBuilt = false;
        let plotsVisible = true, labelsVisible = false;
        
        // Real-time location variables
        let locationMarker = null, locationCircle = null;
        let locationWatchId = null;
        let isLocationActive = false;
        let gpsCurrentLocationMarker = null;

        // Load GeoJSON
        function loadGeoJSONData() {
            map.getContainer().classList.add('loading');
            fetch('./data.geojson').then(r => {
                if (!r.ok) throw new Error('GeoJSON file not found');
                return r.json();
            }).then(data => {
                dataGeo = data;
                plotLayer.addData(data);
                if (plotLayer.getBounds().isValid()) map.fitBounds(plotLayer.getBounds(), { padding: [30, 30] });
                map.getContainer().classList.remove('loading');
                toast('‡§™‡•ç‡§≤‡•â‡§ü‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•Å‡§è');
            }).catch(err => {
                console.error('Error loading GeoJSON:', err);
                map.getContainer().classList.remove('loading');
                toast('GeoJSON ‡§≤‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø');
            });
        }
        loadGeoJSONData();

        // Area calculation
        function calculateArea(feature) {
            try {
                if (!feature) return 0;
                return turf.area(feature);
            } catch (e) {
                console.error('Area calc error:', e);
                return 0;
            }
        }

        // Formatting functions
        function formatAll(area_m2) {
            const sqft = area_m2 * 10.7639104167;
            const acre = sqft / 43560;
            const dismil = acre * 100;
            const kattha = acre * 32;
            const bigha = kattha / 20;
            const dhur = kattha * 20;
            const dhurki = dhur * 20;
            return `${area_m2.toFixed(2)} m¬≤<br>${sqft.toFixed(1)} sq ft<br>${acre.toFixed(4)} acre<br>${dismil.toFixed(2)} dismil<br>${bigha.toFixed(2)} ‡§¨‡•Ä‡§ò‡§æ<br>${kattha.toFixed(2)} ‡§ï‡§ü‡•ç‡§†‡§æ<br>${dhur.toFixed(2)} ‡§ß‡•Å‡§∞<br>${dhurki.toFixed(2)} ‡§ß‡•Å‡§∞‡§ï‡•Ä`;
        }

        function formatSelected(area_m2, unitSelectElement) {
            const unit = unitSelectElement ? unitSelectElement.value : 'sqm';
            const sqft = area_m2 * 10.7639104167;
            const acre = sqft / 43560;
            const dismil = acre * 100;
            const kattha = acre * 32;
            const bigha = kattha / 20;
            const dhur = kattha * 20;
            const dhurki = dhur * 20;
            switch (unit) {
                case 'sqm': return `${area_m2.toFixed(2)} m¬≤`;
                case 'sqft': return `${sqft.toFixed(1)} sq ft`;
                case 'acre': return `${acre.toFixed(4)} acre`;
                case 'dismil': return `${dismil.toFixed(2)} dismil`;
                case 'bigha': return `${bigha.toFixed(2)} ‡§¨‡•Ä‡§ò‡§æ`;
                case 'kattha': return `${kattha.toFixed(2)} ‡§ï‡§ü‡•ç‡§†‡§æ`;
                case 'dhur': return `${dhur.toFixed(2)} ‡§ß‡•Å‡§∞`;
                case 'dhurki': return `${dhurki.toFixed(2)} ‡§ß‡•Å‡§∞‡§ï‡•Ä`;
                default: return `${area_m2.toFixed(2)} m¬≤`;
            }
        }

        function formatLength(meters) {
            if (meters >= 1000) return `${(meters / 1000).toFixed(3)} km`;
            if (meters >= 1) return `${meters.toFixed(2)} m`;
            return `${(meters * 100).toFixed(1)} cm`;
        }

        // UI interactions
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            userGuidePanel.classList.remove('open');
            toast(sidebar.classList.contains('open') ? '‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§ñ‡•Å‡§≤‡§æ' : '‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§¨‡§Ç‡§¶');
        });
        closeSidebarBtn.addEventListener('click', () => { sidebar.classList.remove('open'); toast('‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§¨‡§Ç‡§¶'); });

        homeBtn.addEventListener('click', () => {
            // ensure navigator mode or other tracking stopped
            stopLocationTracking();
            clearMeasure(true);
            clearGpsMeasure(true);
            measuring = false; gpsMeasuring = false;
            measurePanel.style.display = 'none'; gpsMeasurePanel.style.display = 'none';
            sidebar.classList.remove('open'); userGuidePanel.classList.remove('open');
            if (plotLayer.getBounds().isValid()) map.fitBounds(plotLayer.getBounds(), { padding: [30, 30] });
            toast('‡§π‡•ã‡§Æ ‡§™‡§∞ ‡§≤‡•å‡§ü‡•á‡§Ç');
        });

        togglePlotsBtn.addEventListener('change', () => {
            plotsVisible = togglePlotsBtn.checked;
            if (plotsVisible) { map.addLayer(plotLayer); toast('‡§™‡•ç‡§≤‡•â‡§ü‡•ç‡§∏ ‡§ö‡§æ‡§≤‡•Ç'); }
            else { map.removeLayer(plotLayer); toast('‡§™‡•ç‡§≤‡•â‡§ü‡•ç‡§∏ ‡§¨‡§Ç‡§¶'); }
        });

        toggleLabelsBtn.addEventListener('change', () => {
            labelsVisible = toggleLabelsBtn.checked;
            if (labelsVisible) {
                if (!labelsBuilt && map.getZoom() >= MIN_ZOOM_FOR_LABELS) buildLabels();
                if (map.getZoom() >= MIN_ZOOM_FOR_LABELS) map.addLayer(labelLayer);
                else toast('‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§º‡•Ç‡§Æ ‡§ï‡§∞‡•á‡§Ç');
            } else {
                map.removeLayer(labelLayer);
                toast('‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¨‡§Ç‡§¶');
            }
        });

        multiSearchBtn.addEventListener('click', () => {
            const queries = multiPlotInput.value.trim().toLowerCase().split(',').map(q => q.trim()).filter(q => q);
            if (!queries.length) return toast('‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç (‡§â‡§¶‡§æ. 2576 ‡§Ø‡§æ 2576,2577)');
            if (queries.length > MAX_MULTI_SEARCH) return toast(`‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ${MAX_MULTI_SEARCH} ‡§™‡•ç‡§≤‡•â‡§ü‡•ç‡§∏ ‡§ñ‡•ã‡§ú‡•á‡§Ç`);
            if (!dataGeo) return toast('‡§™‡•ç‡§≤‡•â‡§ü‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è');
            const found = [];
            const bounds = L.latLngBounds();
            if (highlightLayer) { map.removeLayer(highlightLayer); highlightLayer = null; }
            highlightLayer = L.geoJSON(null, { style: { color: '#ef4444', weight: 3, fillOpacity: 0.3 } }).addTo(map);
            queries.forEach(q => {
                const feat = (dataGeo.features || []).find(f => {
                    const p = f.properties || {};
                    return [PLOT_PROP, 'plot_no', 'PlotNumber', 'name', 'NAME', 'Plot_No'].some(k => p[k] && String(p[k]).toLowerCase() === q);
                });
                if (feat) {
                    found.push(feat);
                    highlightLayer.addData(feat);
                    bounds.extend(L.geoJSON(feat).getBounds());
                }
            });
            if (!found.length) return toast('‡§ï‡•ã‡§à ‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ');
            const popupContent = found.map(f => {
                const pno = f.properties[PLOT_PROP] ?? 'Unknown';
                const area_m2 = calculateArea(f);
                const c = turf.centroid(f).geometry.coordinates;
                return `<b>‡§™‡•ç‡§≤‡•â‡§ü:</b> ${pno}<br>${formatAll(area_m2)}<br><a href="https://www.google.com/maps?q=${c[1]},${c[0]}" target="_blank">Google Maps ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç</a>`;
            }).join('<hr>');
            if (bounds.isValid()) map.fitBounds(bounds, { padding: [20, 20] });
            const center = bounds.getCenter();
            L.popup().setLatLng(center).setContent(popupContent).openOn(map);
            toast(`‡§™‡•ç‡§≤‡•â‡§ü‡•ç‡§∏ ‡§Æ‡§ø‡§≤‡•á: ${found.length}`);
        });

        resetSearchBtn.addEventListener('click', () => {
            multiPlotInput.value = '';
            if (highlightLayer) { map.removeLayer(highlightLayer); highlightLayer = null; }
            if (plotLayer.getBounds().isValid()) map.fitBounds(plotLayer.getBounds(), { padding: [30, 30] });
            map.closePopup();
            toast('‡§ñ‡•ã‡§ú ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡•Ä ‡§ó‡§à');
        });

        // ---------- Voice Search (‡§¨‡§ø‡§®‡§æ API) ----------
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = "hi-IN";
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            voiceBtn.addEventListener("click", () => {
                toast("üé§ ‡§¨‡•ã‡§≤‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç...");
                try { recognition.start(); }
                catch (e) { console.warn('Recognition start error', e); }
            });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim();
                multiPlotInput.value = transcript;
                toast(`üîç ‡§ñ‡•ã‡§ú‡§æ ‡§ó‡§Ø‡§æ: ${transcript}`);
                multiSearchBtn.click();
            };

            recognition.onerror = (event) => {
                console.error('Speech error', event);
                toast("‡§µ‡•â‡§Ø‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + (event.error || 'error'));
            };

            recognition.onend = () => {
                toast("üé§ ‡§µ‡•â‡§Ø‡§∏ ‡§∏‡§∞‡•ç‡§ö ‡§¨‡§Ç‡§¶");
            };
        } else {
            voiceBtn.addEventListener("click", () => toast("‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§µ‡•â‡§Ø‡§∏ ‡§∏‡§∞‡•ç‡§ö ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à"));
        }

        fitBtn.addEventListener('click', () => {
            if (plotLayer.getBounds().isValid()) map.fitBounds(plotLayer.getBounds(), { padding: [30, 30] });
            else toast('‡§ï‡•ã‡§à ‡§µ‡•à‡§ß ‡§™‡•ç‡§≤‡•â‡§ü ‡§∏‡•Ä‡§Æ‡§æ ‡§®‡§π‡•Ä‡§Ç');
        });

        // Improved Location tracking system
        function stopLocationTracking() {
            if (locationWatchId !== null) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            
            if (locationMarker) {
                map.removeLayer(locationMarker);
                locationMarker = null;
            }
            
            if (locationCircle) {
                map.removeLayer(locationCircle);
                locationCircle = null;
            }
            
            locateBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i><span>‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®</span>';
            locateBtn.classList.remove('loading');
            isLocationActive = false;
        }

        function showLocationError(error) {
            let errorMessage = '‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = '‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡•§ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§ï‡§∞ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç‡•§';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = '‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§';
                    break;
                case error.TIMEOUT:
                    errorMessage = '‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§';
                    break;
                default:
                    errorMessage = '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§';
                    break;
            }
            
            toast(errorMessage);
            locateBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i><span>‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®</span>';
            locateBtn.classList.remove('loading');
            isLocationActive = false;
        }

        function updateLocationUI(position) {
            const { latitude, longitude, accuracy } = position.coords;
            
            // Remove existing markers
            if (locationMarker) map.removeLayer(locationMarker);
            if (locationCircle) map.removeLayer(locationCircle);
            
            // Create new marker with pulse effect
            locationMarker = L.marker([latitude, longitude], {
                icon: L.divIcon({
                    html: `<div class="pulse-marker" style="width:16px;height:16px;border-radius:50%;background:#2563eb;border:3px solid #fff;"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                })
            }).addTo(map);
            
            // Create accuracy circle
            locationCircle = L.circle([latitude, longitude], {
                radius: accuracy,
                color: '#2563eb',
                fillColor: '#3b82f6',
                fillOpacity: 0.2,
                weight: 1
            }).addTo(map);
            
            // Center map on location
            map.setView([latitude, longitude], 18);
            
            // Check which plot user is on
            let foundPlot = null;
            plotLayer.eachLayer(function (layer) {
                if (layer.feature && layer.feature.geometry) {
                    const inside = turf.booleanPointInPolygon(
                        turf.point([longitude, latitude]),
                        layer.feature
                    );
                    if (inside) {
                        foundPlot = layer.feature.properties.Name || "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§";
                    }
                }
            });
            
            // Add popup with location info
            if (foundPlot) {
                locationMarker.bindPopup(
                    `<b>‡§Ü‡§™‡§ï‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®</b><br>
                     ‡§Ö‡§ï‡•ç‡§∑‡§æ‡§Ç‡§∂: ${latitude.toFixed(6)}<br>
                     ‡§¶‡•á‡§∂‡§æ‡§Ç‡§§‡§∞: ${longitude.toFixed(6)}<br>
                     ‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ: ${accuracy.toFixed(1)} ‡§Æ‡•Ä‡§ü‡§∞<br>
                     ‡§™‡•ç‡§≤‡•â‡§ü: ${foundPlot}`
                ).openPopup();
                toast(`‚úÖ ‡§Ü‡§™ ‡§á‡§∏ plot ‡§™‡§∞ ‡§π‡•à‡§Ç: ${foundPlot}`);
            } else {
                locationMarker.bindPopup(
                    `<b>‡§Ü‡§™‡§ï‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®</b><br>
                     ‡§Ö‡§ï‡•ç‡§∑‡§æ‡§Ç‡§∂: ${latitude.toFixed(6)}<br>
                     ‡§¶‡•á‡§∂‡§æ‡§Ç‡§§‡§∞: ${longitude.toFixed(6)}<br>
                     ‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ: ${accuracy.toFixed(1)} ‡§Æ‡•Ä‡§ü‡§∞<br>
                     ‚ö†Ô∏è ‡§ï‡•ã‡§à plot ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ`
                ).openPopup();
                toast("‚ö†Ô∏è ‡§ï‡•ã‡§à plot ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ");
            }
            
            toast('‡§Ü‡§™‡§ï‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à');
        }

        // üìç Locate Button (‡§≤‡•ã‡§ï‡•á‡§∂‡§® + plot number)
        locateBtn.addEventListener("click", () => {
            if (!navigator.geolocation) {
                toast("‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ");
                return;
            }
            
            // ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ location markers ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Ç
            if (locationMarker) map.removeLayer(locationMarker);
            if (locationCircle) map.removeLayer(locationCircle);
            
            locateBtn.classList.add('loading');
            locateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§¢‡•Ç‡§Ç‡§¢ ‡§∞‡§π‡§æ ‡§π‡•à...</span>';
            
            navigator.geolocation.getCurrentPosition((pos) => {
                updateLocationUI(pos);
                locateBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i><span>‡§Æ‡•á‡§∞‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®</span>';
                locateBtn.classList.remove('loading');
                isLocationActive = true;
            }, (err) => {
                showLocationError(err);
            }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
        });

        // Manual measurement
        let measuring = false, pts = [], markers = [], preview = null, liveLabel = null, finalLabel = null;
        function createBlueCircleMarker(latlng) {
            return L.marker(latlng, { 
                icon: L.divIcon({ 
                    html: `<div style="width:12px;height:12px;border-radius:50%;background:transparent;border:3px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.2);"></div>`, 
                    className: '', // Remove default class to avoid conflicts
                    iconSize: [12, 12], 
                    iconAnchor: [6, 6] 
                }), 
                draggable: true 
            });
        }

        measureToggleBtn.addEventListener('click', () => {
            gpsMeasurePanel.style.display = 'none';
            measurePanel.style.display = measurePanel.style.display === 'none' ? 'block' : 'none';
            if (measurePanel.style.display === 'none') {
                clearMeasure(true); measuring = false;
                startMeasureBtn.innerHTML = '<i class="fas fa-play"></i><span>‡§∂‡•Å‡§∞‡•Ç</span>';
                startMeasureBtn.disabled = false; undoMeasureBtn.disabled = true; finishMeasureBtn.disabled = true;
            }
            toast(measurePanel.style.display === 'block' ? '‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Æ‡§æ‡§™ ‡§ü‡•Ç‡§≤ ‡§ñ‡•Å‡§≤‡§æ' : '‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Æ‡§æ‡§™ ‡§ü‡•Ç‡§≤ ‡§¨‡§Ç‡§¶');
        });

        map.on('click', (e) => {
            if (measuring) {
                const marker = createBlueCircleMarker(e.latlng).addTo(map);
                markers.push(marker);
                pts.push([e.latlng.lng, e.latlng.lat]);
                undoMeasureBtn.disabled = false;
                finishMeasureBtn.disabled = pts.length < 3;
                marker.on('drag', (ev) => {
                    try {
                        const idx = markers.indexOf(marker);
                        const p = ev.target.getLatLng();
                        if (idx >= 0) { pts[idx] = [p.lng, p.lat]; updatePreview(); }
                    } catch (ee) { console.error('Drag error:', ee); toast('‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§ñ‡•Ä‡§Ç‡§ö‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø'); }
                });
                updatePreview();
                toast(`‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§ú‡•ã‡§°‡§º‡§æ: ${pts.length}`);
            }
            if (sidebar.classList.contains('open') && !measuring && !gpsMeasuring) {
                sidebar.classList.remove('open');
                userGuidePanel.classList.remove('open');
                toast('‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§¨‡§Ç‡§¶');
            }
        });

        startMeasureBtn.addEventListener('click', () => {
            measuring = !measuring;
            startMeasureBtn.innerHTML = measuring ? '<i class="fas fa-pause"></i><span>‡§∞‡•ã‡§ï‡•á‡§Ç</span>' : '<i class="fas fa-play"></i><span>‡§∂‡•Å‡§∞‡•Ç</span>';
            startMeasureBtn.disabled = false;
            finishMeasureBtn.disabled = pts.length < 3;
            toast(measuring ? '‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Æ‡§æ‡§™ ‡§∂‡•Å‡§∞‡•Ç' : '‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Æ‡§æ‡§™ ‡§∞‡•Å‡§ï‡§æ');
        });

        undoMeasureBtn.addEventListener('click', () => {
            if (markers.length === 0) return;
            const m = markers.pop(); if (m) map.removeLayer(m);
            pts.pop();
            undoMeasureBtn.disabled = markers.length === 0;
            finishMeasureBtn.disabled = pts.length < 3;
            updatePreview();
            toast('‡§™‡§ø‡§õ‡§≤‡§æ ‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§π‡§ü‡§æ‡§Ø‡§æ');
        });

        finishMeasureBtn.addEventListener('click', () => {
            if (pts.length < 3) return toast('‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‚â• 3 ‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§ö‡§æ‡§π‡§ø‡§è');
            measuring = false;
            startMeasureBtn.innerHTML = '<i class="fas fa-play"></i><span>‡§∂‡•Å‡§∞‡•Ç</span>';
            startMeasureBtn.disabled = false; finishMeasureBtn.disabled = true; undoMeasureBtn.disabled = true;
            try {
                const poly = turf.polygon([[...pts, pts[0]]]);
                const area_m2 = turf.area(poly);
                const c = turf.centroid(poly).geometry.coordinates;
                if (finalLabel) map.removeLayer(finalLabel);
                finalLabel = L.marker([c[1], c[0]], { icon: L.divIcon({ html: `<div style="background:white;padding:4px 8px;border-radius:var(--radius);border:1px solid #2563eb;">${formatSelected(area_m2, unitSelect)}</div>` }), interactive: false }).addTo(map);
                toast(`‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≤: ${formatSelected(area_m2, unitSelect)}`);
            } catch (e) {
                console.error('Finish measure error:', e);
                toast('‡§Æ‡§æ‡§™ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø');
            }
        });

        clearMeasureBtn.addEventListener('click', () => {
            clearMeasure(true);
            measuring = false;
            startMeasureBtn.innerHTML = '<i class="fas fa-play"></i><span>‡§∂‡•Å‡§∞‡•Ç</span>';
            startMeasureBtn.disabled = false; finishMeasureBtn.disabled = true; undoMeasureBtn.disabled = true;
            measureInfo.textContent = '‡§¨‡§ø‡§Ç‡§¶‡•Å: 0';
            toast('‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§Æ‡§æ‡§™ ‡§∏‡§æ‡§´‡§º ‡§ï‡§ø‡§Ø‡§æ');
        });

        function clearMeasure(full = true) {
            pts = [];
            markers.forEach(m => map.removeLayer(m)); markers = [];
            if (preview) { map.removeLayer(preview); preview = null; }
            if (liveLabel) { map.removeLayer(liveLabel); liveLabel = null; }
            if (full && finalLabel) { map.removeLayer(finalLabel); finalLabel = null; }
        }

        function updatePreview() {
            if (preview) { map.removeLayer(preview); preview = null; }
            if (liveLabel) { map.removeLayer(liveLabel); liveLabel = null; }
            if (pts.length < 1) {
                measureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${pts.length}`;
                return;
            }
            const latlngs = pts.map(p => [p[1], p[0]]);
            try {
                if (pts.length >= 3) {
                    preview = L.polygon(latlngs, { color: '#2563eb', weight: 2, opacity: 1, fillOpacity: 0.1 }).addTo(map);
                    const poly = turf.polygon([[...pts, pts[0]]]);
                    const area_m2 = turf.area(poly);
                    const perimeter_m = turf.length(turf.lineString([...pts, pts[0]]), { units: 'kilometers' }) * 1000;
                    measureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${pts.length} ‚Ä¢ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞: ${formatSelected(area_m2, unitSelect)} ‚Ä¢ ‡§™‡§∞‡§ø‡§ß‡§ø: ${formatLength(perimeter_m)}`;
                    const c = turf.centroid(poly).geometry.coordinates;
                    liveLabel = L.marker([c[1], c[0]], { icon: L.divIcon({ html: `<div style="background:white;padding:4px 8px;border-radius:var(--radius);border:1px solid #2563eb;">${formatSelected(area_m2, unitSelect)}</div>` }), interactive: false }).addTo(map);
                } else if (pts.length >= 1) {
                    preview = L.polyline(latlngs, { color: '#2563eb', weight: 2 }).addTo(map);
                    const line = turf.lineString(pts);
                    const meters = turf.length(line, { units: 'kilometers' }) * 1000;
                    measureInfo.textContent = `‡§∞‡•á‡§ñ‡§æ: ${formatLength(meters)} ‚Ä¢ ‡§¨‡§ø‡§Ç‡§¶‡•Å: ${pts.length}`;
                    const mid = latlngs[Math.floor(latlngs.length / 2)];
                    liveLabel = L.marker(mid, { icon: L.divIcon({ html: `<div style="background:white;padding:4px 8px;border-radius:var(--radius);border:1px solid #2563eb;">${formatLength(meters)}</div>` }), interactive: false }).addTo(map);
                }
            } catch (e) {
                console.warn('Preview update error:', e);
                toast('‡§Æ‡§æ‡§™ ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç');
            }
        }

        unitSelect.addEventListener('change', () => {
            if (pts.length >= 3) {
                try {
                    const poly = turf.polygon([[...pts, pts[0]]]);
                    const area_m2 = turf.area(poly);
                    const perimeter_m = turf.length(turf.lineString([...pts, pts[0]]), { units: 'kilometers' }) * 1000;
                    if (liveLabel) { map.removeLayer(liveLabel); liveLabel = null; }
                    const c = turf.centroid(poly).geometry.coordinates;
                    liveLabel = L.marker([c[1], c[0]], { icon: L.divIcon({ html: `<div style="background:white;padding:4px 8px;border-radius:var(--radius);border:1px solid #2563eb;">${formatSelected(area_m2, unitSelect)}</div>` }), interactive: false }).addTo(map);
                    measureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${pts.length} ‚Ä¢ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞: ${formatSelected(area_m2, unitSelect)} ‚Ä¢ ‡§™‡§∞‡§ø‡§ß‡§ø: ${formatLength(perimeter_m)}`;
                } catch (e) { console.warn('Unit change error:', e); toast('‡§á‡§ï‡§æ‡§à ‡§¨‡§¶‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø'); }
            } else if (pts.length >= 1) updatePreview();
        });

        // GPS measurement
        let gpsMeasuring = false, gpsPts = [], gpsPreview = null, gpsLiveLabel = null, gpsFinalLabel = null, gpsWatchId = null, lastGpsPosition = null, lastGpsTime = null, gpsMarkers = [];
        let kalmanFilter = { lat: 0, lng: 0, variance: 0.1 };

        function kalmanUpdate(lat, lng, accuracy) {
            const processNoise = 0.0005;
            const measurementNoise = Math.max(accuracy * accuracy * 1.5, 1);
            const predictedVariance = kalmanFilter.variance + processNoise;
            const kalmanGain = predictedVariance / (predictedVariance + measurementNoise);
            kalmanFilter.lat = kalmanFilter.lat + kalmanGain * (lat - kalmanFilter.lat);
            kalmanFilter.lng = kalmanFilter.lng + kalmanGain * (lng - kalmanFilter.lng);
            kalmanFilter.variance = (1 - kalmanGain) * predictedVariance;
            return { lat: kalmanFilter.lat, lng: kalmanFilter.lng };
        }

        // Real-time location tracking function
        function startRealTimeLocationTracking() {
            if (!navigator.geolocation) {
                toast("‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ real-time location ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ");
                return;
            }
            
            // ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ location markers ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Ç
            if (gpsCurrentLocationMarker) map.removeLayer(gpsCurrentLocationMarker);
            
            // Real-time location tracking ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
            gpsWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    const ll = [latitude, longitude];
                    
                    // Real-time location marker update ‡§ï‡§∞‡•á‡§Ç
                    if (!gpsCurrentLocationMarker) {
                        gpsCurrentLocationMarker = L.marker(ll, {
                            icon: L.divIcon({
                                html: `<div class="pulse-marker" style="width:16px;height:16px;border-radius:50%;background:#2563eb;border:3px solid #fff;"></div>`,
                                iconSize: [16, 16],
                                iconAnchor: [8, 8]
                            })
                        }).addTo(map);
                    } else {
                        gpsCurrentLocationMarker.setLatLng(ll);
                    }
                    
                    // Accuracy circle update ‡§ï‡§∞‡•á‡§Ç
                    if (locationCircle) map.removeLayer(locationCircle);
                    locationCircle = L.circle(ll, {
                        radius: accuracy,
                        color: '#2563eb',
                        fillColor: '#3b82f6',
                        fillOpacity: 0.2,
                        weight: 1
                    }).addTo(map);
                    
                    // Map ‡§ï‡•ã real-time location ‡§™‡§∞ center ‡§ï‡§∞‡•á‡§Ç
                    map.panTo(ll, { animate: true, duration: 0.5 });
                    
                    // ‡§Ø‡§π check ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø user ‡§ï‡§ø‡§∏ plot ‡§™‡§∞ ‡§π‡•à
                    let foundPlot = null;
                    plotLayer.eachLayer(function (layer) {
                        if (layer.feature && layer.feature.geometry) {
                            const inside = turf.booleanPointInPolygon(
                                turf.point([longitude, latitude]),
                                layer.feature
                            );
                            if (inside) {
                                foundPlot = layer.feature.properties.Name || "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§";
                            }
                        }
                    });
                    
                    // Real-time location marker ‡§ï‡•á popup ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä update ‡§ï‡§∞‡•á‡§Ç
                    if (foundPlot) {
                        gpsCurrentLocationMarker.bindPopup(`üìç ‡§Ü‡§™‡§ï‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®<br>Plot: ${foundPlot}`).openPopup();
                    } else {
                        gpsCurrentLocationMarker.bindPopup("üìç ‡§Ü‡§™‡§ï‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§®<br>‚ö†Ô∏è ‡§ï‡•ã‡§à plot ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ").openPopup();
                    }
                },
                (error) => {
                    toast("Real-time location ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + error.message);
                },
                { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
            );
        }

        gpsMeasureToggleBtn.addEventListener('click', () => {
            measurePanel.style.display = 'none';
            gpsMeasurePanel.style.display = gpsMeasurePanel.style.display === 'none' ? 'block' : 'none';
            if (gpsMeasurePanel.style.display === 'none') {
                clearGpsMeasure(true); gpsMeasuring = false;
                startGpsMeasureBtn.innerHTML = '<i class="fas fa-play"></i><span>‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç</span>';
                startGpsMeasureBtn.disabled = false; stopGpsMeasureBtn.disabled = true; finishGpsMeasureBtn.disabled = true;
            }
            toast(gpsMeasurePanel.style.display === 'block' ? '‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Æ‡§æ‡§™ ‡§ü‡•Ç‡§≤ ‡§ñ‡•Å‡§≤‡§æ' : '‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Æ‡§æ‡§™ ‡§ü‡•Ç‡§≤ ‡§¨‡§Ç‡§¶');
        });

        startGpsMeasureBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                console.error('Geolocation not supported by browser');
                return toast('‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç');
            }
            
            gpsMeasuring = !gpsMeasuring;
            startGpsMeasureBtn.innerHTML = gpsMeasuring ? '<i class="fas fa-pause"></i><span>‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•á‡§Ç</span>' : '<i class="fas fa-play"></i><span>‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç</span>';
            startGpsMeasureBtn.disabled = false; 
            stopGpsMeasureBtn.disabled = !gpsMeasuring;
            finishGpsMeasureBtn.disabled = gpsPts.length < 3;
            
            if (gpsMeasuring) {
                console.log('Starting GPS measurement with real-time tracking');
                toast('‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç‡•§ ‡§™‡•ç‡§≤‡•â‡§ü ‡§ï‡•á ‡§ö‡§æ‡§∞‡•ã‡§Ç ‡§ì‡§∞ ‡§ß‡•Ä‡§∞‡•á-‡§ß‡•Ä‡§∞‡•á ‡§ò‡•Ç‡§Æ‡•á‡§Ç‡•§');
                
                // Real-time location tracking ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
                startRealTimeLocationTracking();
                
                // GPS points record ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è watchPosition ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
                gpsWatchId = navigator.geolocation.watchPosition(updateGpsPosition, gpsError, { 
                    enableHighAccuracy: true, 
                    maximumAge: 200, 
                    timeout: 5000 
                });
            } else {
                if (gpsWatchId) { 
                    navigator.geolocation.clearWatch(gpsWatchId); 
                    gpsWatchId = null; 
                }
                console.log('GPS measurement paused');
                toast('‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡•Å‡§ï‡•Ä');
            }
        });

        stopGpsMeasureBtn.addEventListener('click', () => {
            gpsMeasuring = false;
            startGpsMeasureBtn.innerHTML = '<i class="fas fa-play"></i><span>‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç</span>';
            stopGpsMeasureBtn.disabled = true;
            finishGpsMeasureBtn.disabled = gpsPts.length < 3;
            
            if (gpsWatchId) { 
                navigator.geolocation.clearWatch(gpsWatchId); 
                gpsWatchId = null; 
            }
            
            // Real-time location marker ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Ç
            if (gpsCurrentLocationMarker) {
                map.removeLayer(gpsCurrentLocationMarker);
                gpsCurrentLocationMarker = null;
            }
            
            console.log('GPS measurement stopped');
            toast('‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•Ä ‡§ó‡§à');
        });

        finishGpsMeasureBtn.addEventListener('click', () => {
            if (gpsPts.length < 3) return toast('‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‚â• 3 ‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§ö‡§æ‡§π‡§ø‡§è');
            gpsMeasuring = false;
            startGpsMeasureBtn.innerHTML = '<i class="fas fa-play"></i><span>‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç</span>';
            startGpsMeasureBtn.disabled = false; 
            stopGpsMeasureBtn.disabled = true; 
            finishGpsMeasureBtn.disabled = true;
            
            if (gpsWatchId) { 
                navigator.geolocation.clearWatch(gpsWatchId); 
                gpsWatchId = null; 
            }
            
            // Real-time location marker ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Ç
            if (gpsCurrentLocationMarker) {
                map.removeLayer(gpsCurrentLocationMarker);
                gpsCurrentLocationMarker = null;
            }
            
            try {
                const closedPts = [...gpsPts, gpsPts[0]];
                const poly = turf.polygon([closedPts]);
                const area_m2 = turf.area(poly);
                const c = turf.centroid(poly).geometry.coordinates;
                
                if (gpsFinalLabel) map.removeLayer(gpsFinalLabel);
                gpsFinalLabel = L.marker([c[1], c[0]], { 
                    icon: L.divIcon({ 
                        html: `<div style="background:white;padding:4px 8px;border-radius:var(--radius);border:1px solid #059669;">${formatSelected(area_m2, gpsUnitSelect)}</div>` 
                    }), 
                    interactive: false 
                }).addTo(map);
                
                if (gpsPreview) map.removeLayer(gpsPreview);
                gpsPreview = L.polygon(gpsPts.map(p => [p[1], p[0]]), { 
                    color: '#059669', 
                    weight: 3, 
                    opacity: 1, 
                    fillOpacity: 0.2 
                }).addTo(map);
                
                gpsMeasureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${gpsPts.length} | ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞: ${formatSelected(area_m2, gpsUnitSelect)} | ‡§™‡§∞‡§ø‡§ß‡§ø: ${formatLength(turf.length(turf.lineString(closedPts), { units: 'kilometers' }) * 1000)}`;
                console.log(`GPS measurement finished: Area=${formatSelected(area_m2, gpsUnitSelect)}`);
                toast(`‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≤: ${formatSelected(area_m2, gpsUnitSelect)}`);
            } catch (e) {
                console.error('Finish GPS measure error:', e);
                toast('‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Æ‡§æ‡§™ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø');
            }
        });

        clearGpsMeasureBtn.addEventListener('click', () => {
            clearGpsMeasure(true);
            gpsMeasuring = false;
            startGpsMeasureBtn.innerHTML = '<i class="fas fa-play"></i><span>‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç</span>';
            startGpsMeasureBtn.disabled = false; 
            stopGpsMeasureBtn.disabled = true; 
            finishGpsMeasureBtn.disabled = true;
            gpsMeasureInfo.textContent = '‡§¨‡§ø‡§Ç‡§¶‡•Å: 0 | ‡§¶‡•Ç‡§∞‡•Ä: 0 m';
            
            // Real-time location marker ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Ç
            if (gpsCurrentLocationMarker) {
                map.removeLayer(gpsCurrentLocationMarker);
                gpsCurrentLocationMarker = null;
            }
            
            console.log('GPS measurement cleared');
            toast('‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Æ‡§æ‡§™ ‡§∏‡§æ‡§´‡§º ‡§ï‡§ø‡§Ø‡§æ');
        });

        function gpsError(err) {
            let message = '‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø';
            if (err.code === 1) message = '‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§';
            else if (err.code === 2) message = '‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Ö‡§®‡•Å‡§™‡§≤‡§¨‡•ç‡§ß';
            else if (err.code === 3) message = '‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§ü‡§æ‡§á‡§Æ‡§Ü‡§â‡§ü';
            console.error(`GPS error: ${err.message} (Code: ${err.code})`);
            toast(message);
            gpsMeasuring = false;
            startGpsMeasureBtn.innerHTML = '<i class="fas fa-play"></i><span>‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç</span>';
            stopGpsMeasureBtn.disabled = true; finishGpsMeasureBtn.disabled = true;
            if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
        }

        function updateGpsPosition(pos) {
            const { latitude, longitude, accuracy, speed, timestamp } = pos.coords;
            console.log(`GPS Update [${new Date(timestamp).toISOString()}]: Lat=${latitude}, Lng=${longitude}, Accuracy=${accuracy}m, Speed=${speed || 'N/A'}m/s`);

            if (accuracy > GPS_ACCURACY_THRESHOLD) {
                console.log(`Discarded: Accuracy too low (>${GPS_ACCURACY_THRESHOLD}m)`);
                toast('‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ ‡§ï‡§Æ, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ñ‡•Å‡§≤‡•á ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§è‡§Ç');
                gpsMeasureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${gpsPts.length} | ‡§¶‡•Ç‡§∞‡•Ä: ${gpsPts.length > 1 ? formatLength(turf.length(turf.lineString(gpsPts), { units: 'kilometers' }) * 1000) : '0 m'} | ‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ ‡§ï‡§Æ`;
                return;
            }

            const effectiveSpeed = speed !== null && speed !== undefined ? speed : 0.2;
            if (effectiveSpeed < GPS_MIN_SPEED) {
                console.log(`Discarded: Speed too low (<${GPS_MIN_SPEED}m/s)`);
                toast('‡§∏‡•ç‡§•‡§ø‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ö‡§≤‡•á‡§Ç');
                gpsMeasureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${gpsPts.length} | ‡§¶‡•Ç‡§∞‡•Ä: ${gpsPts.length > 1 ? formatLength(turf.length(turf.lineString(gpsPts), { units: 'kilometers' }) * 1000) : '0 m'} | ‡§∏‡•ç‡§•‡§ø‡§∞`;
                return;
            }

            if (lastGpsTime && (timestamp - lastGpsTime < GPS_MIN_TIME)) {
                console.log(`Discarded: Too soon since last point (<${GPS_MIN_TIME}ms)`);
                gpsMeasureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${gpsPts.length} | ‡§¶‡•Ç‡§∞‡•Ä: ${gpsPts.length > 1 ? formatLength(turf.length(turf.lineString(gpsPts), { units: 'kilometers' }) * 1000) : '0 m'} | ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç`;
                return;
            }

            const filtered = kalmanUpdate(latitude, longitude, accuracy);
            const ll = [filtered.lat, filtered.lng];
            const currentPoint = turf.point([filtered.lng, filtered.lat]);
            if (lastGpsPosition && turf.distance(lastGpsPosition, currentPoint, { units: 'meters' }) < GPS_MIN_DISTANCE) {
                console.log(`Discarded: Too close to last point (<${GPS_MIN_DISTANCE}m)`);
                gpsMeasureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${gpsPts.length} | ‡§¶‡•Ç‡§∞‡•Ä: ${gpsPts.length > 1 ? formatLength(turf.length(turf.lineString(gpsPts), { units: 'kilometers' }) * 1000) : '0 m'} | ‡§¨‡§π‡•Å‡§§ ‡§™‡§æ‡§∏`;
                return;
            }

            lastGpsPosition = currentPoint;
            lastGpsTime = timestamp;
            gpsPts.push([filtered.lng, filtered.lat]);

            const marker = L.marker(ll, { 
                icon: L.divIcon({ 
                    html: `<div style="width:10px;height:10px;border-radius:50%;background:#059669;border:2px solid white;"></div>`, 
                    iconSize: [10, 10], 
                    iconAnchor: [5, 5] 
                }) 
            }).addTo(map);
            gpsMarkers.push(marker);

            if (gpsMarkers.length > 1) {
                gpsMarkers[gpsMarkers.length - 2].setIcon(L.divIcon({ 
                    html: `<div style="width:10px;height:10px;border-radius:50%;background:#059669;border:2px solid white;"></div>`, 
                    iconSize: [10, 10], 
                    iconAnchor: [5, 5] 
                }));
            }
            marker.setIcon(L.divIcon({ 
                html: `<div class="pulse-marker" style="width:12px;height:12px;border-radius:50%;background:#ef4444;border:2px solid white;"></div>`, 
                iconSize: [12, 12], 
                iconAnchor: [6, 6] 
            }));

            updateGpsPreview();
            console.log(`GPS point added: ${gpsPts.length}, Lat=${filtered.lat}, Lng=${filtered.lng}`);
            toast(`‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§ú‡•ã‡§°‡§º‡§æ: ${gpsPts.length}`);
            map.panTo(ll, { animate: true, duration: 0.5 });
        }

        function updateGpsPreview() {
            if (gpsPreview) { map.removeLayer(gpsPreview); gpsPreview = null; }
            if (gpsLiveLabel) { map.removeLayer(gpsLiveLabel); gpsLiveLabel = null; }
            if (gpsPts.length < 1) {
                gpsMeasureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${gpsPts.length} | ‡§¶‡•Ç‡§∞‡•Ä: 0 m`;
                return;
            }
            try {
                gpsPreview = L.polyline(gpsPts.map(p => [p[1], p[0]]), { color: '#ef4444', weight: 3, opacity: 1 }).addTo(map);
                const line = turf.lineString(gpsPts);
                const meters = turf.length(line, { units: 'kilometers' }) * 1000;
                gpsMeasureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${gpsPts.length} | ‡§¶‡•Ç‡§∞‡•Ä: ${formatLength(meters)}`;
                if (gpsPts.length >= 3) {
                    const closedPts = [...gpsPts, gpsPts[0]];
                    const poly = turf.polygon([closedPts]);
                    const area_m2 = turf.area(poly);
                    const perimeter_m = turf.length(turf.lineString(closedPts), { units: 'kilometers' }) * 1000;
                    gpsMeasureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${gpsPts.length} | ‡§¶‡•Ç‡§∞‡•Ä: ${formatLength(meters)} | ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞: ${formatSelected(area_m2, gpsUnitSelect)} | ‡§™‡§∞‡§ø‡§ß‡§ø: ${formatLength(perimeter_m)}`;
                    const c = turf.centroid(poly).geometry.coordinates;
                    gpsLiveLabel = L.marker([c[1], c[0]], { icon: L.divIcon({ html: `<div style="background:white;padding:4px 8px;border-radius:var(--radius);border:1px solid #059669;">${formatSelected(area_m2, gpsUnitSelect)}</div>` }), interactive: false }).addTo(map);
                } else {
                    const mid = gpsPts[Math.floor(gpsPts.length / 2)];
                    gpsLiveLabel = L.marker([mid[1], mid[0]], { icon: L.divIcon({ html: `<div style="background:white;padding:4px 8px;border-radius:var(--radius);border:1px solid #059669;">${formatLength(meters)}</div>` }), interactive: false }).addTo(map);
                }
                finishGpsMeasureBtn.disabled = gpsPts.length < 3;
            } catch (e) {
                console.warn('GPS Preview update error:', e);
                toast('‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§Æ‡§æ‡§™ ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ö‡§≤‡§§‡•á ‡§∞‡§π‡•á‡§Ç');
            }
        }

        function clearGpsMeasure(full = true) {
            gpsPts = [];
            gpsMarkers.forEach(m => map.removeLayer(m)); gpsMarkers = [];
            if (gpsPreview) { map.removeLayer(gpsPreview); gpsPreview = null; }
            if (gpsLiveLabel) { map.removeLayer(gpsLiveLabel); gpsLiveLabel = null; }
            if (full && gpsFinalLabel) { map.removeLayer(gpsFinalLabel); gpsFinalLabel = null; }
            lastGpsPosition = null;
            lastGpsTime = null;
            if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
            kalmanFilter = { lat: 0, lng: 0, variance: 0.1 };
            
            // Real-time location marker ‡§ï‡•ã ‡§π‡§ü‡§æ‡§è‡§Ç
            if (gpsCurrentLocationMarker) {
                map.removeLayer(gpsCurrentLocationMarker);
                gpsCurrentLocationMarker = null;
            }
        }

        gpsUnitSelect.addEventListener('change', () => {
            if (gpsPts.length >= 3) {
                try {
                    const closedPts = [...gpsPts, gpsPts[0]];
                    const poly = turf.polygon([closedPts]);
                    const area_m2 = turf.area(poly);
                    const perimeter_m = turf.length(turf.lineString(closedPts), { units: 'kilometers' }) * 1000;
                    if (gpsLiveLabel) { map.removeLayer(gpsLiveLabel); gpsLiveLabel = null; }
                    const c = turf.centroid(poly).geometry.coordinates;
                    gpsLiveLabel = L.marker([c[1], c[0]], { icon: L.divIcon({ html: `<div style="background:white;padding:4px 8px;border-radius:var(--radius);border:1px solid #059669;">${formatSelected(area_m2, gpsUnitSelect)}</div>` }), interactive: false }).addTo(map);
                    gpsMeasureInfo.textContent = `‡§¨‡§ø‡§Ç‡§¶‡•Å: ${gpsPts.length} | ‡§¶‡•Ç‡§∞‡•Ä: ${formatLength(turf.length(turf.lineString(gpsPts), { units: 'kilometers' }) * 1000)} | ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞: ${formatSelected(area_m2, gpsUnitSelect)} | ‡§™‡§∞‡§ø‡§ß‡§ø: ${formatLength(perimeter_m)}`;
                } catch (e) { console.warn('GPS Unit change error:', e); toast('‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§á‡§ï‡§æ‡§à ‡§¨‡§¶‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø'); }
            } else if (gpsPts.length >= 1) updateGpsPreview();
        });

        // Label building
        function buildLabels() {
            if (!dataGeo || labelsBuilt || map.getZoom() < MIN_ZOOM_FOR_LABELS) return;
            labelLayer.clearLayers();
            const features = dataGeo.features || [];
            let processed = 0;
            function processBatch(startIdx) {
                const endIdx = Math.min(startIdx + LABEL_BATCH_SIZE, features.length);
                for (let i = startIdx; i < endIdx; i++) {
                    try {
                        const f = features[i];
                        const name = f?.properties?.[PLOT_PROP] ?? 'Unknown';
                        if (!name || name === 'Unknown') continue;
                        const c = turf.centroid(f).geometry.coordinates;
                        labelLayer.addLayer(L.marker([c[1], c[0]], { icon: L.divIcon({ className: 'plot-label', html: `<div style="background:transparent;font-weight:500;color:#000;font-size:10px;text-align:center;">${name}</div>` }), interactive: false }));
                        processed++;
                    } catch (e) { console.warn('Label error:', e); }
                }
                if (endIdx < features.length) requestAnimationFrame(() => processBatch(endIdx));
                else { labelsBuilt = true; toast(`‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§¨‡§®‡§æ‡§è ‡§ó‡§è: ${processed} ‡§™‡•ç‡§≤‡•â‡§ü‡•ç‡§∏`); }
            }
            processBatch(0);
        }

        map.on('zoomend', () => {
            if (labelsVisible && !labelsBuilt && map.getZoom() >= MIN_ZOOM_FOR_LABELS) buildLabels();
            if (labelsVisible && map.getZoom() < MIN_ZOOM_FOR_LABELS) map.removeLayer(labelLayer);
            else if (labelsVisible && map.getZoom() >= MIN_ZOOM_FOR_LABELS && labelsBuilt) map.addLayer(labelLayer);
        });

        userGuideBtn.addEventListener('click', () => {
            userGuidePanel.style.transform = 'translateX(0)'; userGuidePanel.style.display = 'block'; sidebar.classList.remove('open'); toast('‡§ó‡§æ‡§á‡§° ‡§ñ‡•Å‡§≤‡§æ');
        });
        closeGuideBtn.addEventListener('click', () => { userGuidePanel.style.transform = 'translateX(-120%)'; toast('‡§ó‡§æ‡§á‡§° ‡§¨‡§Ç‡§¶'); });

        document.addEventListener('click', (e) => {
            if (!sidebar.contains(e.target) && !menuBtn.contains(e.target) && !userGuidePanel.contains(e.target) && !userGuideBtn.contains(e.target) && !measuring && !gpsMeasuring) {
                if (sidebar.classList.contains('open')) { sidebar.classList.remove('open'); userGuidePanel.style.transform = 'translateX(-120%)'; toast('‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§¨‡§Ç‡§¶'); }
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { sidebar.classList.remove('open'); userGuidePanel.style.transform = 'translateX(-120%)'; toast('‡§¨‡§Ç‡§¶ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ'); }
        });

        Array.from(document.querySelectorAll('.sidebar .btn-3d')).forEach(btn => {
            if (!btn.title) {
                const txt = btn.querySelector('span')?.textContent?.trim();
                if (txt) btn.title = txt;
            }
        });
    </script>
</body>
<style>html{
 color:darkviolet;
 font-size:25px;
 font-weight:600;
}
</style><script>/*Here write your javascript code*/</script></html>